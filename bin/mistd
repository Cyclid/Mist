#!/usr/bin/env ruby
# Copyright (C) 2016 Liqwyd Ltd.
# This program is free software; you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation; version 2.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program; if not, write to the Free Software Foundation, Inc., 51 Franklin
# Street, Fifth Floor, Boston, MA 02110-1301, USA.
$LOAD_PATH.push File.expand_path('../../lib', __FILE__)

require 'logger'
require 'optparse'
require 'msgpack/rpc'
require 'mist/logger'
require 'mist/config'

begin
  require 'mist/handlers/gce'
rescue LoadError
  STDERR.puts 'GCE is not available'
end

begin
  require 'mist/handlers/lxc'
rescue LoadError
  STDERR.puts 'LXC is not available'
end

options = { daemonize: false, config: File.join(%w(/ etc mist config)), type: nil, workers: 5 }
OptionParser.new do |opts|
  opts.on('-d', '--daemon', 'Run the Mist server as a background daemon') do |_daemon|
    options[:daemonize] = true
  end

  opts.on('-c', '--config PATH', 'Path to the configuration file') do |path|
    options[:config] = path
  end

  opts.on('-t', '--type TYPE', 'Type of instances to create ("gce" or "lxc")') do |type|
    options[:type] = type
  end

  opts.on('-w', '--workers NUM', 'Number of workers to create') do |num|
    options[:workers] = num
  end
end.parse!

abort 'You must specify the server type: one of "lxc" or "gce"' unless options[:type]

config = Mist::Config.new(options[:config])
Mist.logger.debug config.inspect

if options[:daemonize]
  # Provide our own file logger
  Mist.logger = Logger.new(File.join(%w(/ var log mist.log)))

  # Become a daemon & start processing requests
  Process.daemon(false, false)
else
  # Log to stderr
  Mist.logger = Logger.new(STDERR)
end

# Start the RPC event loop
begin
  Mist.logger.info "Mist server starting with PID #{Process.pid}"

  threads = []
  if options[:type] == 'gce'
    (0..options[:workers]).each do |num|
      server = Mist::GceServer.new(config, num)
      threads << Thread.new do
        server.run
      end
    end
  elsif options[:type] == 'lxc'
    (0..options[:workers]).each do |num|
      server = Mist::LxcServer.new(config, num)
      threads << Thread.new do
        server.run
      end
    end
  else
    abort "Unknown server type #{options[:type]}"
  end

  threads.each(&:join)
rescue StandardError => ex
  Mist.logger.error "failed to start Mist server: #{ex}"
  abort
end

Mist.logger.info 'Mist server exiting'
exit 0
